<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ESP32 |</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --ink: #1a1a1a;
        --paper: #ffffff;
        --border-width: 1.5px;
      }

      body {
        background-color: #e5e5e5;
        background-image: url("https://www.transparenttextures.com/patterns/paper-fibers.png");
        color: var(--ink);
        font-family: "Courier New", Courier, monospace;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0;
        padding: 20px;
      }

      .document-container {
        background: var(--paper);
        width: 95%;
        max-width: 1200px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border: 1px solid #ccc;
      }

      header {
        border-bottom: var(--border-width) solid var(--ink);
        margin-bottom: 30px;
        padding-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .status-area {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .led-container {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: bold;
        font-size: 0.8rem;
      }
      .led-circle {
        width: 12px;
        height: 12px;
        border: 2px solid var(--ink);
        border-radius: 50%;
        transition: background 0.1s;
      }
      .led-on {
        background: var(--ink);
      }

      button {
        background: transparent;
        border: var(--border-width) solid var(--ink);
        padding: 8px 16px;
        font-family: inherit;
        cursor: pointer;
        text-transform: uppercase;
      }

      button:hover {
        background: var(--ink);
        color: var(--paper);
      }

      .horizontal-graphs {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        margin-top: 20px;
      }

      .graph-item {
        flex: 1;
        border: var(--border-width) solid var(--ink);
        padding: 15px;
        min-width: 0;
      }

      .graph-label {
        font-size: 0.7rem;
        font-weight: bold;
        text-transform: uppercase;
        margin-bottom: 15px;
        display: block;
        text-align: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
      }

      .big-value {
        font-size: 1.5rem;
        display: block;
        text-align: center;
        margin-bottom: 10px;
      }

      canvas {
        height: 200px !important;
      }
    </style>
  </head>
  <body>
    <div class="document-container">
      <header>
        <h1>Data and Graph report</h1>
        <div class="status-area">
          <div class="led-container">
            DEVICE LED:
            <div id="ledIndicator" class="led-circle"></div>
            <span id="ledStatus">OFF</span>
          </div>
          <button id="connectBtn">Connect</button>
        </div>
      </header>

      <div class="horizontal-graphs">
        <div class="graph-item">
          <span class="graph-label">01. Touch Sensor</span>
          <span class="big-value" id="touchVal">--</span>
          <canvas id="chartTouch"></canvas>
        </div>

        <div class="graph-item">
          <span class="graph-label">02. Temperature (Â°C)</span>
          <span class="big-value" id="tempVal">--</span>
          <canvas id="chartTemp"></canvas>
        </div>

        <div class="graph-item">
          <span class="graph-label">03. Humidity (%)</span>
          <span class="big-value" id="humidVal">--</span>
          <canvas id="chartHumid"></canvas>
        </div>
      </div>
    </div>

    <script>
      let port, reader;
      const maxPoints = 20;
      const charts = {};
      const threshold = 300;

      function initChart(id) {
        return new Chart(document.getElementById(id), {
          type: "line",
          data: {
            labels: Array(maxPoints).fill(""),
            datasets: [
              {
                data: Array(maxPoints).fill(null),
                borderColor: "#1a1a1a",
                borderWidth: 1.5,
                pointRadius: 0,
                fill: false,
                tension: 0.2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { display: false },
              y: { ticks: { font: { size: 9 } } },
            },
            animation: false,
          },
        });
      }

      charts.touch = initChart("chartTouch");
      charts.temp = initChart("chartTemp");
      charts.humid = initChart("chartHumid");

      document
        .getElementById("connectBtn")
        .addEventListener("click", async () => {
          try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 });
            document.getElementById("connectBtn").style.display = "none";

            const decoder = new TextDecoderStream();
            port.readable.pipeTo(decoder.writable);
            reader = decoder.readable.getReader();
            readLoop();
          } catch (e) {
            console.error(e);
          }
        });

      async function readLoop() {
        let buffer = "";
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += value;
          let lines = buffer.split("\n");
          buffer = lines.pop();

          for (let line of lines) {
            let parts = line.trim().split(",");
            if (parts.length === 3) {
              const t = parseFloat(parts[0]);
              const te = parseFloat(parts[1]);
              const h = parseFloat(parts[2]);

              document.getElementById("touchVal").innerText = t;
              document.getElementById("tempVal").innerText = te;
              document.getElementById("humidVal").innerText = h;

              const ledCircle = document.getElementById("ledIndicator");
              const ledText = document.getElementById("ledStatus");
              if (t < threshold) {
                ledCircle.classList.add("led-on");
                ledText.innerText = "ON";
              } else {
                ledCircle.classList.remove("led-on");
                ledText.innerText = "OFF";
              }

              updateChart(charts.touch, t);
              updateChart(charts.temp, te);
              updateChart(charts.humid, h);
            }
          }
        }
      }

      function updateChart(chart, val) {
        chart.data.datasets[0].data.push(val);
        chart.data.datasets[0].data.shift();
        chart.update("none");
      }
    </script>
  </body>
</html>
